@model IEnumerable<Microsoft.AspNetCore.Identity.IdentityUser>
@{
    ViewData["Title"] = "إدارة المستخدمين";
    Layout = "_Layout";
    var userRoles = ViewBag.UserRoles as Dictionary<string, string>;
}

<div class="container-fluid mt-4">
    <div class="row mb-4 align-items-center">
        <div class="col-md-6">
            <h2 class="text-primary fw-bold"><i class="fas fa-users-cog me-2"></i> إدارة مستخدمي النظام</h2>
        </div>
        <div class="col-md-6 text-start">
            <a asp-action="CreateUser" class="btn btn-primary px-4 rounded-pill shadow-sm">
                <i class="fas fa-user-plus me-1"></i> إضافة مستخدم جديد
            </a>
        </div>
    </div>

    <div class="card border-0 shadow-sm rounded-4 p-0 overflow-hidden">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4">اسم المستخدم</th>
                        <th>البريد الإلكتروني</th>
                        <th>الدور</th>
                        <th class="text-center">الإجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in Model)
                    {
                        var currentRole = userRoles != null && userRoles.ContainsKey(user.Id) ? userRoles[user.Id] : "بدون صلاحية";
                        <tr>
                            <td class="ps-4 fw-bold">@user.UserName</td>
                            <td class="text-muted">@user.Email</td>
                            <td>
                                <span class="badge @GetBadgeClass(currentRole) px-3 py-2 rounded-pill">
                                    @currentRole
                                </span>
                            </td>
                            <td class="text-center">
                                <div class="btn-group">
                                    <a asp-action="EditUser" asp-route-id="@user.Id" class="btn btn-outline-info btn-sm rounded-start">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a asp-action="DeleteUser" asp-route-id="@user.Id" class="btn btn-outline-danger btn-sm rounded-end" onclick="return confirm('هل أنت متأكد من حذف هذا المستخدم؟')">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                                @{
                                    var isLocked = user.LockoutEnd != null && user.LockoutEnd > DateTime.Now;
                                }
                                <a asp-action="DeactivateUser" asp-route-id="@user.Id" class="btn btn-sm @(isLocked ? "btn-success" : "btn-outline-secondary") ms-2 rounded-pill px-3">
                                    <i class="fas @(isLocked ? "fa-check-circle" : "fa-ban") me-1"></i> @(isLocked ? "تفعيل" : "إيقاف")
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@functions {
    public string GetBadgeClass(string role)
    {
        return role switch
        {
            "Admin" => "bg-danger",
            "Doctor" => "bg-primary",
            "Pharmacist" => "bg-success",
            "Secretary" => "bg-info",
            _ => "bg-secondary"
        };
    }
}

<style>
    .text-primary { color: #008080 !important; }
    .bg-primary { background-color: #008080 !important; }
    .btn-primary { background-color: #008080; border-color: #008080; }
    .btn-primary:hover { background-color: #006666; }
    .btn-outline-primary { color: #008080; border-color: #008080; }
</style>